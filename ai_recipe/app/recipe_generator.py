import re
import openai
from openai import OpenAI
from app.config import OPENAI_API_KEY



KNOWN_INGREDIENTS_HE = {
    "אבטיח", "אבקת אפייה", "אבקת סודה", "אבקת סוכר", "אגוז מוסקט", "אגס", "אורגנו", "אורז", "אזוב", "אטריות",
    "אמנון", "אננס", "אפונה", "אפונה יבשה", "אפרסק", "ארטישוק", "אשכולית", "בהרט", "בורגול", "בזיליקום",
    "ביצה", "ביצים קשות", "בצל", "בצל ירוק", "בטטה", "במיה", "ברוקולי", "בשמל", "גבינה", "גבינה לבנה",
    "גבינה צהובה", "גבינת קוטג׳", "גבינת שמנת", "גבינת פטה", "גבינת גאודה", "גבינת צ'דר", "גזר", "גרגרי חרדל",
    "גרנולה", "דג", "דג מרלוזה", "דבש", "דובדבנים", "דניס", "הודו", "וניל", "חזה הודו", "חזה עוף",
    "חלב", "חלב שקדים", "חלב סויה", "חלב שיבולת שועל", "חלה", "חומוס", "חסה", "חיטה", "חלב מרוכז",
    "חמאה", "חמין", "חציל", "טחינה", "טחינה גולמית", "טחינה ירוקה", "טופו", "טלה", "טימין", "טונה",
    "יין אדום", "יין לבן", "יוגורט", "כוסברה", "כמון", "כורכום", "כרוב", "כרובית", "כרישה", "כנפיים",
    "לחם", "לחוח", "לחמנייה", "לימון", "לבן", "ליים", "מלח", "מלח גס", "מלח ים", "מלון",
    "מלפפון", "מנגו", "מנטה", "מרגרינה", "מרשמלו", "מסטיק", "משמש", "מים", "מים פושרים", "מים רותחים",
    "מיץ לימון", "מיץ תפוזים", "נקטרינה", "נקניק", "עלי בייבי", "עלי דפנה", "עוגה", "עוגת גבינה", "עוגת שוקולד",
    "עוגיות", "עוף", "עוף בגריל", "עוף שלם", "עולש", "עגבנייה", "עגבניות מיובשות", "עדשים", "עין", "עפרונות סוכר",
    "פאק צ'וי", "פול", "פטרוזיליה", "פטריות", "פילה דג", "פילה סלמון", "פיתה", "פיתה קלויה", "פלפל אדום",
    "פלפל ירוק", "פלפל לבן", "פלפל שחור", "פלפל צהוב", "פנקייק", "פסטה", "פצפוצי שוקולד", "פצפוצי אורז",
    "פסטרמה", "פתיתים", "פרג", "פרמזן", "פרפה", "צ׳ילי", "צנון", "צימוקים", "קייל", "קקאו",
    "קוקוס טחון", "קוקוס קלוי", "קורנפלקס", "קוסקוס", "קטשופ", "קלמנטינה", "קרח", "קרמל", "קרקר", "קצפת",
    "קציצות", "קציצות ירק", "קציצות בשר", "קציצות עוף", "קפה", "קפה נמס", "קפה טורקי", "קמח", "קמח תירס",
    "קינמון", "קינואה", "קקאו מריר", "קשיו", "רוזמרין", "ריבת תפוזים", "ריבת תות", "ריבת חלב", "ריקוטה",
    "רוטב עגבניות", "רוטב ברביקיו", "רוטב פסטו", "רוטב שמנת", "רוטב סויה", "רוטב צ׳ילי", "רסק עגבניות",
    "רולדה", "סוכר", "סוכר חום", "סוכריות", "סוכריות קישוט", "סילאן", "סלט ביצים", "סלט טונה", "סלט טבולה",
    "סלט יווני", "סלט כרוב", "סמבוסק", "סרדינים", "סטייק", "שוקולד", "שוקולד מריר", "שוקולד לבן",
    "שמן זית", "שמן חמניות", "שמן קנולה", "שמיר", "שמרים", "שני ביצים", "שעועית ירוקה", "שעועית לבנה",
    "שעועית שחורה", "שזיף", "שום", "שניצל", "שווארמה", "תה", "תות", "תבלין גריל", "תבלין לפיצה",
    "תבלין פיצה", "תבלין קארי", "תערובת תיבול", "תפוח", "תפוח אדמה", "תמרים", "תרד"
}

STOPWORDS_HE = {"עם", "וגם", "קצת", "של", "מעט", "ו", "ו-", "ו."}

client = OpenAI(api_key=OPENAI_API_KEY)

def extract_hebrew_ingredients(text: str):
    text = text.lower()
    text = re.sub(r"[^\w\sא-ת]", "", text)
    words = text.split()
    words = [w.lstrip("ו") for w in words if w not in STOPWORDS_HE]

    final = []
    i = 0
    while i < len(words):
        if i + 1 < len(words):
            two = f"{words[i]} {words[i+1]}"
            if two in KNOWN_INGREDIENTS_HE:
                final.append(two)
                i += 2
                continue
        if words[i] in KNOWN_INGREDIENTS_HE:
            final.append(words[i])
        i += 1
    return final

def generate_recipe_with_openai(ingredients: list[str]) -> dict:
    prompt = (
        f"יש לי את הרכיבים הבאים: {', '.join(ingredients)}.\n"
        "אנא כתוב לי מתכון ביתי וטעים שכולל:\n"
        "- שם מנה בעברית\n"
        "- רשימת מצרכים\n"
        "- הוראות הכנה פשוטות וברורות"
    )

    openai.api_key = OPENAI_API_KEY
    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "אתה שף ישראלי מקצועי, תן מתכונים בעברית בלבד."},
            {"role": "user", "content": prompt}
        ],
        temperature=0.7,
        max_tokens=700
    )

    content = response.choices[0].message.content.strip()

    # פיצול המצורף למרכיבים והוראות הכנה
    parts = content.split("הוראות הכנה:")
    ingredients_text = parts[0].replace("מצרכים:", "").strip() if len(parts) > 1 else ""
    instructions = parts[1].strip() if len(parts) > 1 else content

    return {
        "title": f"מנה עם {' ו'.join(ingredients)}",
        "ingredients": ingredients,
        "ingredients_text": ingredients_text,
        "instructions": instructions
    }